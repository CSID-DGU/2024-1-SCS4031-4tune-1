<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>부정행위 감지 데모</title>
    </head>
    <body>
        <h1>부정행위 감지 데모</h1>
        <video id="video" width="640" height="480" autoplay muted></video>
        <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
        <div id="result"></div>

        <script>
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const resultDiv = document.getElementById('result');

            // 사용자 ID 설정
            const userId = 'user123';

            // WebSocket 연결
            const ws = new WebSocket(`ws://localhost:8000/ws/${userId}`);

            ws.onopen = function() {
                console.log('WebSocket 연결이 열렸습니다.');
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('서버로부터 메시지 수신:', data);
                resultDiv.innerText = JSON.stringify(data.cheating_counts, null, 2);
            };

            ws.onclose = function() {
                console.log('WebSocket 연결이 닫혔습니다.');
            };

            // 웹캠 스트림 시작
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    startSendingFrames();
                })
                .catch(function(err) {
                    console.log('웹캠 스트림을 가져오는 데 실패했습니다.', err);
                });

            function startSendingFrames() {
                const context = canvas.getContext('2d');

                setInterval(function() {
                    // 캔버스에 현재 프레임을 그림
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // 캔버스로부터 이미지 데이터 추출
                    canvas.toBlob(function(blob) {
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            const base64data = reader.result.split(',')[1];  // "data:image/png;base64," 부분 제거
                            // 서버로 전송
                            ws.send(base64data);
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.8);  // JPEG 포맷으로 이미지 품질 80%로 설정
                }, 500);  // 500ms마다 프레임 전송 (초당 2프레임)
            }
        </script>
    </body>
</html>